<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Paiement sÃ©curisÃ©</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>ğŸ’³ Paiement sÃ©curisÃ©</h1>
      <p>
        ğŸ§¾ Code de commande :
        <span id="code_commande">inconnu</span>
      </p>
      <input
        type="text"
        id="code_paiement"
        placeholder="Code de paiement (123456)"
      />
      <button onclick="validerPaiement()">Valider</button>
      <div id="confirmation"></div>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const nom = urlParams.get("nom");
      const tel = urlParams.get("tel");
      const cat1 = urlParams.get("cat1");
      const qt1 = urlParams.get("qt1");
      const cat2 = urlParams.get("cat2");
      const qt2 = urlParams.get("qt2");
      const cat3 = urlParams.get("cat3");
      const qt3 = urlParams.get("qt3");

      if (!nom || nom.includes(" ")) {
        document.body.innerHTML =
          "<h2 style='color:red'>â›” Le nom ne doit pas contenir dâ€™espace</h2>";
        throw new Error("Nom invalide");
      }

      const commande = {
        nom,
        tel,
        cat1,
        qt1,
        cat2,
        qt2,
        cat3,
        qt3,
      };

      fetch("/api/commande", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(commande),
      })
        .then((res) => res.json())
        .then((data) => {
          document.getElementById("code_commande").innerText = data.code;
          window.codeCommande = data.code;
        });

      function validerPaiement() {
        const codePaiement = document.getElementById("code_paiement").value;
        fetch("/api/payer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            code: window.codeCommande,
            code_paiement: codePaiement,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              document.getElementById("confirmation").innerHTML =
                "<p style='color:green'>âœ… Paiement validÃ© ! ğŸŸï¸</p>";
            } else {
              document.getElementById("confirmation").innerHTML =
                "<p style='color:red'>â›” Erreur : " + data.message + "</p>";
            }
          });
      }
    </script>
  </body>
</html>
